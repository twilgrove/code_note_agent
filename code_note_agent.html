<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Agent (v0.8.1 File Count)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --gray: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --error: #ef4444;
            --warn: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* é¡¶éƒ¨ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .version {
            font-size: 0.8rem;
            background: #e0e7ff;
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .badge {
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 99px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .badge-ok {
            background: #dcfce7;
            color: #15803d;
        }

        .badge-err {
            background: #fee2e2;
            color: #b91c1c;
        }

        /* å¡ç‰‡ */
        .card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
        }

        .step-locked {
            opacity: 0.6;
            pointer-events: none;
            filter: grayscale(1);
            user-select: none;
        }

        .step-active {
            border-color: var(--primary);
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.1);
            transform: translateY(-2px);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .step-num {
            background: var(--text);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .step-active .step-num {
            background: var(--primary);
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* è¡¨å•ç½‘æ ¼ */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 6px;
        }

        input,
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            outline: none;
            font-size: 0.95rem;
            background: #fff;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Checkbox æ ·å¼ä¼˜åŒ– */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
            font-size: 0.9rem;
            color: var(--text);
            cursor: pointer;
        }
        .checkbox-wrapper input {
            width: auto;
            margin: 0;
        }

        /* æŒ‰é’®ç³»ç»Ÿ */
        .btn-group {
            display: flex;
            gap: 12px;
        }

        button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        /* é”™è¯¯çŠ¶æ€æŒ‰é’® */
        .btn-error {
            background: var(--error);
            color: white;
            width: 100%;
        }

        .btn-error:hover {
            background: #dc2626;
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--border);
            color: var(--text);
            flex: 1;
        }

        .btn-outline:hover {
            background: #f8fafc;
            border-color: var(--gray);
        }

        .btn-icon {
            background: none;
            padding: 4px;
            color: var(--gray);
            width: auto;
            flex: none;
        }

        .btn-icon:hover {
            color: var(--primary);
            background: #e0e7ff;
            border-radius: 4px;
        }

        /* é«˜çº§é…ç½®åŒºåŸŸ */
        .advanced-box {
            margin-top: 10px;
            padding: 12px;
            background: #f8fafc;
            border: 1px dashed var(--border);
            border-radius: 8px;
            display: none;
        }

        .advanced-toggle {
            font-size: 0.8rem;
            color: var(--primary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }

        /* æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ */
        .file-list-box {
            margin-top: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            background: #fff;
            padding: 8px;
            display: none;
        }
        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-bottom: 1px solid #f1f5f9;
            font-family: monospace;
            font-size: 0.85rem;
        }
        .file-item:last-child { border-bottom: none; }
        .file-item:hover { background-color: #f8fafc; }
        .file-item input[type="checkbox"] { width: auto; margin: 0; cursor: pointer; }
        .file-item span { cursor: pointer; word-break: break-all; }

        /* æ—¥å¿—ä¸è¿›åº¦ */
        .console {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            height: 220px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', Consolas, monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            margin-top: 20px;
            border: 1px solid #334155;
        }

        .log-time {
            color: #64748b;
            margin-right: 8px;
            user-select: none;
        }

        .log-sys {
            color: #93c5fd;
        }

        .log-ok {
            color: #4ade80;
        }

        .log-err {
            color: #f87171;
        }

        .log-warn {
            color: #fbbf24;
        }

        .log-info {
            color: #60a5fa;
        }

        .log-wait {
            color: #c084fc;
            font-style: italic;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar-bg {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #818cf8);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* è·¯å¾„æ ‡ç­¾ */
        .path-display {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            display: none;
        }

        .path-tag {
            display: inline-block;
            background: #e0e7ff;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: monospace;
            word-break: break-all;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>ğŸ¤– Code Agent <span class="version">v0.8.1</span></h1>
        <div id="envBadge" class="badge badge-err">
            <span>Checking Env...</span>
        </div>
    </div>

    <div class="card step-active" id="step1">
        <div class="step-header">
            <span class="step-num">1</span>
            <span class="step-title">è¿æ¥ AI å¤§è„‘</span>
            <button class="btn-icon" style="margin-left:auto" onclick="resetApp()" title="é‡ç½®">ğŸ”„</button>
        </div>

        <div class="form-grid">
            <div class="full-width">
                <label>é€‰æ‹©æœåŠ¡å•† (Provider)</label>
                <select id="providerSelect" onchange="handleProviderChange()">
                    <option value="deepseek" selected>DeepSeek (æ·±åº¦æ±‚ç´¢)</option>
                    <option value="moonshot">Kimi (æœˆä¹‹æš—é¢)</option>
                    <option value="doubao">Doubao (ç«å±±å¼•æ“)</option>
                    <option value="gemini">Gemini (Google)</option>
                    <option value="ollama">Local Ollama (æœ¬åœ°)</option>
                    <option value="custom">Custom (å…¶ä»–å…¼å®¹æ¥å£)</option>
                </select>
            </div>

            <div class="full-width">
                <label>API Key <span style="font-weight:400; color:var(--gray)">(æœ¬åœ°æ¨¡å‹å¯ç•™ç©º)</span></label>
                <div style="position:relative">
                    <input type="password" id="apiKey" placeholder="sk-..." oninput="resetConnect()">
                    <button class="btn-icon" style="position:absolute; right:8px; top:50%; transform:translateY(-50%)"
                        onclick="toggleKey()">ğŸ‘ï¸</button>
                </div>
            </div>

            <div class="full-width">
                <div class="advanced-toggle" onclick="toggleAdvanced()">
                    <span>âš™ï¸ é…ç½®æ¥å£åœ°å€ (Base URL)</span>
                    <span id="baseUrlPreview" style="color:var(--gray); margin-left:10px; font-size:0.75rem;"></span>
                </div>
                <div class="advanced-box" id="advancedArea">
                    <label>Base URL (API Endpoint)</label>
                    <input type="text" id="baseUrl" placeholder="https://..." oninput="resetConnect()">
                </div>
            </div>

            <div class="full-width" id="customConfigArea" style="display:none;">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="customUseManual" onchange="handleProviderChange()">
                    â˜‘ï¸ æ‰‹åŠ¨è¾“å…¥æ¨¡å‹/æ¥å…¥ç‚¹ ID (è·³è¿‡åˆ—è¡¨è·å–)
                </label>
            </div>

            <div class="full-width" id="modelSelectionArea" style="display:none; animation: fadeIn 0.5s;">
                <label>é€‰æ‹©æ¨¡å‹ (Model) - <span style="font-weight:400; font-size:0.8em; color:var(--primary)">ç‚¹å‡»åˆ‡æ¢æ¨¡å‹å°†è‡ªåŠ¨éªŒè¯</span></label>
                <select id="modelSelect" onchange="handleModelSelect()">
                </select>
                <input type="text" id="manualModel" placeholder="è¯·è¾“å…¥æ¨¡å‹åç§°" style="display:none; margin-top:8px;">
            </div>

            <div class="full-width" id="endpointInputArea" style="display:none; animation: fadeIn 0.5s;">
                <label id="endpointLabel">æ¥å…¥ç‚¹ ID (Endpoint ID)</label>
                <input type="text" id="manualEndpoint" placeholder="ep-202406xx-xxxxx" oninput="resetConnect()">
                <div id="endpointHint" style="font-size:0.75rem; color:var(--gray); margin-top:4px;">
                    ğŸ’¡ å‰å¾€ç«å±±å¼•æ“æ§åˆ¶å°åˆ›å»ºæ¥å…¥ç‚¹ï¼Œå¤åˆ¶ ep-xxxx ID å¡«å…¥æ­¤å¤„ã€‚
                </div>
            </div>

            <div class="full-width">
                <button class="btn-primary" id="btnConnect" onclick="connectAndFetchModels()">
                    âš¡ è¿æ¥å¹¶éªŒè¯
                </button>
            </div>
        </div>
    </div>

    <div class="card step-locked" id="step2">
        <div class="step-header">
            <span class="step-num">2</span>
            <span class="step-title">é€‰æ‹©æºç ç›®å½•</span>
        </div>

        <div class="btn-group">
            <button class="btn-outline" onclick="selectIn()">ğŸ“‚ é€‰æ‹©æºä»£ç æ–‡ä»¶å¤¹</button>
            <button class="btn-outline" onclick="selectOut()">ğŸ’¾ é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹</button>
        </div>

        <div class="path-display" id="pathDisplay">
            <div>ğŸ“¥ è¾“å…¥: <span id="inLabel" class="path-tag">æœªé€‰æ‹©</span></div>
            <div>ğŸ“¤ è¾“å‡º: <span id="outLabel" class="path-tag">æœªé€‰æ‹©</span></div>
        </div>

        <div id="fileListArea" class="file-list-box">
            <div style="padding:10px; text-align:center; color:var(--gray)">è¯·å…ˆé€‰æ‹©è¾“å…¥æ–‡ä»¶å¤¹...</div>
        </div>
        <div id="fileSummary" style="font-size:0.8rem; color:var(--gray); margin-top:5px; display:none; text-align:right">
            </div>
    </div>

    <div class="card step-locked" id="step3">
        <div class="step-header">
            <span class="step-num">3</span>
            <span class="step-title">å¼€å§‹ä»»åŠ¡</span>
        </div>

        <button class="btn-primary" id="btnStart" onclick="startTask()" style="padding: 14px; font-size: 1.1rem;">
            ğŸš€ å¯åŠ¨æ™ºèƒ½æ³¨é‡Š Agent
        </button>

        <div class="progress-container" id="progressBox">
            <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:5px;">
                <div>
                    <span id="progressText" style="font-weight:600">0%</span>
                    <span id="progressCount" style="color:var(--gray); font-size:0.9em; margin-left:8px;">(0/0)</span>
                    
                    <span id="runTimer" style="margin-left:10px; color:var(--primary); font-weight:600; display:none">0.0s</span>
                </div>
                <span id="fileStatus" style="color:var(--gray)">ç­‰å¾…å¼€å§‹...</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <div class="console" id="console">
        <div style="color:var(--gray)">> System initialized. Ready.</div>
    </div>

    <script>
        // --- é…ç½® ---
        const PROVIDERS = {
            deepseek: { name: "DeepSeek (æ·±åº¦æ±‚ç´¢)", baseUrl: "https://api.deepseek.com", type: "openai", presets: ["deepseek-chat", "deepseek-coder"] },
            gemini: { name: "Gemini (Google)", baseUrl: "https://generativelanguage.googleapis.com/v1beta", type: "gemini", presets: [] },
            doubao: { name: "Doubao (ç«å±±å¼•æ“)", baseUrl: "https://ark.cn-beijing.volces.com/api/v3", type: "doubao", presets: [] },
            moonshot: { name: "Kimi (æœˆä¹‹æš—é¢)", baseUrl: "https://api.moonshot.cn/v1", type: "openai", presets: ["moonshot-v1-8k", "moonshot-v1-32k"] },
            ollama: { name: "Ollama (Local)", baseUrl: "http://localhost:11434/v1", type: "openai", presets: ["llama3", "mistral", "qwen2"] },
            custom: { name: "Custom / Proxy", baseUrl: "", type: "openai", presets: [] }
        };

        const CONFIG = {
            ignoreExts: ['.png', '.jpg', '.jpeg', '.gif', '.pdf', '.exe', '.dll', '.bin', '.zip', '.mp4', '.git', '.DS_Store', '.pyc', '.class', '.o', '.obj'],
            ignoreDirs: ['.git', 'node_modules', 'dist', 'build', '__pycache__', '.idea', '.vscode', 'target', 'vendor']
        };

        const STATE = {
            provider: 'deepseek',
            baseUrl: '',
            key: '',
            model: '',
            inHandle: null,
            outHandle: null,
            totalFiles: 0,
            fileList: [], 
            filesToCopy: new Set(), 
            processed: 0,
            timer: null
        };

        window.addEventListener('DOMContentLoaded', () => {
            if ('showDirectoryPicker' in window) {
                document.getElementById('envBadge').className = 'badge badge-ok';
                document.getElementById('envBadge').innerHTML = 'âœ… æµè§ˆå™¨å·²å°±ç»ª';
                loadConfig();
            } else {
                document.getElementById('envBadge').innerHTML = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒ';
                alert("æœ¬å·¥å…·ä¾èµ– File System APIï¼Œè¯·ä½¿ç”¨ Chrome / Edge æµè§ˆå™¨");
            }
        });

        // --- UI é€»è¾‘ ---
        function handleProviderChange() {
            const pKey = document.getElementById('providerSelect').value;
            const config = PROVIDERS[pKey];
            document.getElementById('baseUrl').value = config.baseUrl;
            document.getElementById('baseUrlPreview').textContent = config.baseUrl;

            const cachedKey = localStorage.getItem('aca_key_' + pKey);
            document.getElementById('apiKey').value = cachedKey || '';

            document.getElementById('customConfigArea').style.display = (pKey === 'custom') ? 'block' : 'none';
            
            const isCustomManual = (pKey === 'custom' && document.getElementById('customUseManual').checked);
            const isManualMode = (pKey === 'doubao') || isCustomManual;

            if (isManualMode) {
                document.getElementById('modelSelectionArea').style.display = 'none';
                document.getElementById('endpointInputArea').style.display = 'block';
                
                const cachedEp = localStorage.getItem('aca_manual_ep_' + pKey);
                document.getElementById('manualEndpoint').value = cachedEp || '';

                if(pKey === 'doubao') {
                    document.getElementById('endpointLabel').innerText = "æ¥å…¥ç‚¹ ID (Endpoint ID)";
                    document.getElementById('endpointHint').style.display = 'block';
                } else {
                    document.getElementById('endpointLabel').innerText = "æ¨¡å‹ ID / éƒ¨ç½² ID";
                    document.getElementById('endpointHint').style.display = 'none';
                }
            } else {
                document.getElementById('modelSelectionArea').style.display = 'none';
                document.getElementById('endpointInputArea').style.display = 'none';
            }
            resetConnect();
        }

        function toggleAdvanced() {
            const area = document.getElementById('advancedArea');
            area.style.display = area.style.display === 'block' ? 'none' : 'block';
        }

        function resetConnect() {
            const btn = document.getElementById('btnConnect');
            btn.disabled = false;
            btn.textContent = "âš¡ è¿æ¥å¹¶éªŒè¯";
            btn.className = "btn-primary";

            const pKey = document.getElementById('providerSelect').value;
            const isCustomManual = (pKey === 'custom' && document.getElementById('customUseManual').checked);
            if (pKey !== 'doubao' && !isCustomManual) {
                document.getElementById('modelSelectionArea').style.display = "none";
            }
            lockStep(2);
            lockStep(3);
        }

        async function handleModelSelect() {
            const val = document.getElementById('modelSelect').value;
            const isManual = (val === 'CUSTOM_MANUAL');
            document.getElementById('manualModel').style.display = isManual ? 'block' : 'none';

            if (isManual || !val) return;

            const btn = document.getElementById('btnConnect');
            const pKey = document.getElementById('providerSelect').value;
            const config = PROVIDERS[pKey];
            const key = document.getElementById('apiKey').value.trim();
            const baseUrl = document.getElementById('baseUrl').value.replace(/\/$/, '');

            btn.disabled = true;
            btn.textContent = `âŒ› éªŒè¯æ¨¡å‹ [${val}]...`;
            btn.className = "btn-primary";

            try {
                let url, body, headers = { 'Content-Type': 'application/json' };
                
                if (config.type === 'gemini') {
                    url = `${baseUrl}/models/${val}:generateContent?key=${key}`;
                    body = { contents: [{ parts: [{ text: "hi" }] }] };
                } else {
                    url = `${baseUrl}/chat/completions`;
                    if (key) headers['Authorization'] = `Bearer ${key}`;
                    body = {
                        model: val,
                        messages: [{ role: "user", content: "hi" }],
                        max_tokens: 1
                    };
                }

                const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`HTTP ${res.status}: ${txt.slice(0, 30)}`);
                }

                log(`âœ… æ¨¡å‹ [${val}] è¿æ¥æˆåŠŸ`, 'ok');
                btn.textContent = `âœ… å·²è¿æ¥: ${val}`;
                btn.className = "btn-primary";
                
                STATE.model = val;
                saveConfig();

            } catch (e) {
                log(`âŒ æ¨¡å‹ [${val}] è¿æ¥å¤±è´¥: ${e.message}`, 'err');
                btn.textContent = `âŒ ${val} å¤±è´¥`;
                btn.className = "btn-error";
            } finally {
                btn.disabled = false;
            }
        }

        async function connectAndFetchModels() {
            const btn = document.getElementById('btnConnect');
            const pKey = document.getElementById('providerSelect').value;
            const config = PROVIDERS[pKey];
            const key = document.getElementById('apiKey').value.trim();
            let baseUrl = document.getElementById('baseUrl').value.replace(/\/$/, '');

            if (!baseUrl) return alert("Base URL ä¸èƒ½ä¸ºç©º");
            if (!key && pKey !== 'ollama' && pKey !== 'custom') return alert("è¯·è¾“å…¥ API Key");

            btn.disabled = true;
            btn.textContent = "âŒ› è¿æ¥ä¸­...";
            log(`æ­£åœ¨è¿æ¥ ${config.name}...`, 'sys');

            const isCustomManual = (pKey === 'custom' && document.getElementById('customUseManual').checked);
            
            if (pKey === 'doubao' || isCustomManual) {
                const ep = document.getElementById('manualEndpoint').value.trim();
                if (!ep) {
                    btn.disabled = false;
                    btn.textContent = "âŒ ç¼ºå°‘ ID";
                    return alert("è¯·è¾“å…¥æ¥å…¥ç‚¹ ID / æ¨¡å‹ ID");
                }

                try {
                    log(`éªŒè¯ ID: ${ep}...`, 'sys');
                    const res = await fetch(`${baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                        body: JSON.stringify({ model: ep, messages: [{ role: "user", content: "hi" }], max_tokens: 1 })
                    });

                    if (res.status === 401) throw new Error("Key æ— æ•ˆ (401)");
                    if (res.status === 404) throw new Error("ID ä¸å­˜åœ¨ (404)");
                    if (!res.ok) {
                        const txt = await res.text();
                        throw new Error(`HTTP ${res.status}: ${txt.slice(0, 50)}`);
                    }

                    const data = await res.json();
                    let connectedName = ep;
                    if(data.model && data.model !== ep) {
                        connectedName = `${ep} (${data.model})`;
                    }

                    STATE.model = ep;
                    STATE.baseUrl = baseUrl;
                    STATE.key = key;
                    STATE.provider = pKey;
                    saveConfig();

                    log(`âœ… éªŒè¯é€šè¿‡ï¼`, 'ok');
                    btn.textContent = `âœ… å·²è¿æ¥: ${connectedName}`;
                    btn.className = "btn-primary";
                    unlockStep(2);
                    checkStep3(); 

                } catch (e) {
                    log(`âŒ è¿æ¥å¤±è´¥: ${e.message}`, 'err');
                    btn.textContent = "âŒ å¤±è´¥ (ç‚¹å‡»é‡è¯•)";
                    btn.className = "btn-error";
                    btn.disabled = false;
                }
                return;
            }

            let models = [];
            let fetchSuccess = false;

            try {
                if (config.type === 'gemini') {
                    const res = await fetch(`${baseUrl}/models?key=${key}`);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    models = (data.models || []).filter(m => m.supportedGenerationMethods?.includes("generateContent")).map(m => m.name.replace("models/", ""));
                } else {
                    const headers = { 'Content-Type': 'application/json' };
                    if (key) headers['Authorization'] = `Bearer ${key}`;
                    const res = await fetch(`${baseUrl}/models`, { method: 'GET', headers });

                    if (res.status === 402) throw new Error("PAYMENT_REQUIRED");
                    if (res.status === 401 || res.status === 403) throw new Error(`AUTH_ERROR`);

                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    models = (data.data || []).map(m => m.id);
                }
                fetchSuccess = true;
                log(`âœ… è·å–åˆ° ${models.length} ä¸ªæ¨¡å‹`, 'ok');
            } catch (e) {
                let errorMsg = `HTTP ${e.message}`;
                if (e.message === 'PAYMENT_REQUIRED') errorMsg = "ä½™é¢ä¸è¶³";
                else if (e.message.includes('AUTH_ERROR')) errorMsg = "Key æ— æ•ˆ";

                if (e.message.includes('AUTH_ERROR') || e.message === 'PAYMENT_REQUIRED') {
                    log(`âŒ è¿æ¥å¤±è´¥: ${errorMsg}`, 'err');
                    btn.textContent = `âŒ ${errorMsg} (é‡è¯•)`;
                    btn.className = "btn-error";
                    btn.disabled = false;
                    return;
                }
                log(`âš ï¸ è‡ªåŠ¨è·å–åˆ—è¡¨å¤±è´¥ (${e.message})ï¼Œä½¿ç”¨é¢„è®¾ã€‚`, 'warn');
                models = config.presets || [];
            }

            const select = document.getElementById('modelSelect');
            select.innerHTML = "";

            if (models.length === 0) {
                select.appendChild(new Option("âœï¸ è¯·æ‰‹åŠ¨è¾“å…¥æ¨¡å‹å...", "CUSTOM_MANUAL"));
            } else {
                models.forEach(m => select.appendChild(new Option((fetchSuccess ? "ğŸŸ¢ " : "ğŸ“¦ ") + m, m)));
                select.appendChild(new Option("âœï¸ æ‰‹åŠ¨è¾“å…¥...", "CUSTOM_MANUAL"));
                select.value = models[0];
            }
            
            STATE.baseUrl = baseUrl;
            STATE.key = key;
            STATE.provider = pKey;
            saveConfig();

            document.getElementById('modelSelectionArea').style.display = "block";
            
            select.value = models[0];
            await handleModelSelect(); 

            unlockStep(2);
            checkStep3(); 
        }

        async function selectIn() {
            try {
                STATE.inHandle = await window.showDirectoryPicker({ mode: 'read' });
                document.getElementById('inLabel').textContent = STATE.inHandle.name;
                document.getElementById('pathDisplay').style.display = 'block';
                
                log(`æ­£åœ¨æ‰«æç›®å½•: ${STATE.inHandle.name}...`, 'sys');
                
                STATE.fileList = await buildFileList(STATE.inHandle);
                STATE.totalFiles = STATE.fileList.length;
                
                renderFileList();
                
                log(`å…±å‘ç° ${STATE.totalFiles} ä¸ªæ–‡ä»¶`, 'ok');
                checkStep3();
            } catch (e) { 
                console.error(e);
            }
        }

        async function buildFileList(dirHandle, path = "") {
            let files = [];
            for await (const entry of dirHandle.values()) {
                const relPath = path ? `${path}/${entry.name}` : entry.name;
                if (entry.kind === 'file') {
                    if (shouldProcess(entry.name)) {
                        files.push(relPath);
                    }
                } else if (entry.kind === 'directory' && !CONFIG.ignoreDirs.includes(entry.name)) {
                    files = files.concat(await buildFileList(entry, relPath));
                }
            }
            return files;
        }

        function renderFileList() {
            const listArea = document.getElementById('fileListArea');
            listArea.innerHTML = ""; 
            
            if (STATE.fileList.length === 0) {
                listArea.innerHTML = '<div style="padding:10px; text-align:center; color:var(--gray)">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä»£ç æ–‡ä»¶</div>';
                return;
            }

            STATE.fileList.forEach((path, idx) => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `
                    <input type="checkbox" id="f_${idx}" checked data-path="${path}">
                    <label for="f_${idx}" style="font-weight:400; font-size:0.85rem; margin:0; cursor:pointer">${path}</label>
                `;
                listArea.appendChild(div);
            });
            
            listArea.style.display = 'block';
            updateSummary();
            
            listArea.querySelectorAll('input').forEach(chk => {
                chk.addEventListener('change', updateSummary);
            });
        }

        function updateSummary() {
            const total = STATE.fileList.length;
            const checked = document.querySelectorAll('#fileListArea input:checked').length;
            const unchecked = total - checked;
            const sumEl = document.getElementById('fileSummary');
            sumEl.style.display = 'block';
            sumEl.innerHTML = `å…± ${total} ä¸ª | <span style="color:var(--primary)">ğŸ¤– AIå¤„ç†: ${checked}</span> | <span style="color:var(--gray)">ğŸ“„ åŸæ ·å¤åˆ¶: ${unchecked}</span>`;
        }

        async function selectOut() {
            try {
                STATE.outHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                document.getElementById('outLabel').textContent = STATE.outHandle.name;
                document.getElementById('pathDisplay').style.display = 'block';
                checkStep3();
            } catch (e) { }
        }

        function shouldProcess(name) { return !CONFIG.ignoreExts.some(e => name.toLowerCase().endsWith(e)); }
        function isCode(n) { return ['.js', '.py', '.java', '.c', '.cpp', '.h', '.hpp', '.html', '.css', '.ts', '.go', '.rs', '.php', '.sh', '.yaml', '.json', '.xml', '.vue', '.sql', '.txt', '.md'].some(e => n.toLowerCase().endsWith(e)); }

        async function scanDir(handle) {
            let count = 0;
            for await (const entry of handle.values()) {
                if (entry.kind === 'file') { if (shouldProcess(entry.name)) count++; }
                else if (entry.kind === 'directory' && !CONFIG.ignoreDirs.includes(entry.name)) count += await scanDir(entry);
            }
            return count;
        }

        async function startTask() {
            if (STATE.totalFiles === 0) return alert("ç›®å½•ä¸ºç©º");

            const pKey = STATE.provider;
            const isCustomManual = (pKey === 'custom' && document.getElementById('customUseManual').checked);

            if (pKey === 'doubao' || isCustomManual) {
                STATE.model = document.getElementById('manualEndpoint').value.trim();
            } else {
                const sv = document.getElementById('modelSelect').value;
                STATE.model = (sv === 'CUSTOM_MANUAL') ? document.getElementById('manualModel').value.trim() : sv;
            }

            if (!STATE.model) return alert("è¯·æŒ‡å®šæ¨¡å‹/æ¥å…¥ç‚¹");

            STATE.filesToCopy.clear();
            const checkboxes = document.querySelectorAll('#fileListArea input[type="checkbox"]');
            checkboxes.forEach(chk => {
                if (!chk.checked) {
                    STATE.filesToCopy.add(chk.getAttribute('data-path'));
                }
            });

            const btn = document.getElementById('btnStart');
            btn.disabled = true;
            document.getElementById('progressBox').style.display = "block";
            STATE.processed = 0;
            updateUI(0, "å¯åŠ¨ä¸­...");

            const startTime = Date.now();
            const timerEl = document.getElementById('runTimer');
            timerEl.style.display = 'inline-block';

            if (STATE.timer) clearInterval(STATE.timer);
            STATE.timer = setInterval(() => {
                timerEl.textContent = ((Date.now() - startTime) / 1000).toFixed(1) + 's';
            }, 100);

            log("ğŸš€ ä»»åŠ¡å¼€å§‹...", 'sys');

            try {
                await processRecursive(STATE.inHandle, STATE.outHandle, "");
                updateUI(100, "âœ… å®Œæˆ");

                clearInterval(STATE.timer);
                const timeStr = formatDuration(Date.now() - startTime);
                timerEl.textContent = timeStr;
                log(`ğŸ‰ å®Œæˆï¼æ€»è€—æ—¶: ${timeStr}`, 'ok');
                alert(`å¤„ç†å®Œæˆï¼è€—æ—¶: ${timeStr}`);
            } catch (e) {
                clearInterval(STATE.timer);
                log(`âŒ ä¸­æ–­: ${e.message}`, 'err');
            } finally {
                btn.disabled = false;
            }
        }

        function formatDuration(ms) {
            const s = ms / 1000;
            if (s < 60) return `${s.toFixed(1)}ç§’`;
            const m = Math.floor(s / 60);
            const rs = Math.floor(s % 60);
            return `${m}åˆ†${rs}ç§’`;
        }

        async function processRecursive(inDir, outDir, prefix) {
            for await (const entry of inDir.values()) {
                const relPath = prefix ? `${prefix}/${entry.name}` : entry.name;
                
                if (entry.kind === 'file') {
                    if (!shouldProcess(entry.name)) continue;
                    
                    const isCopyOnly = STATE.filesToCopy.has(relPath);
                    const actionName = isCopyOnly ? "å¤åˆ¶" : "AIå¤„ç†";
                    
                    updateUI(null, `${actionName}: ${relPath}`);

                    const file = await entry.getFile();
                    const text = await file.text();
                    let content = text;

                    if (!isCopyOnly && isCode(entry.name)) {
                        try {
                            content = await callAI(text, entry.name, relPath);
                            log(`[AI OK] ${relPath}`, 'ok');
                        } catch (e) {
                            log(`[AI FAIL] ${relPath}: ${e.message} (å·²ä¿ç•™åŸæ–‡ä»¶)`, 'err');
                        }
                    }

                    const newFile = await outDir.getFileHandle(entry.name, { create: true });
                    const w = await newFile.createWritable();
                    await w.write(content);
                    await w.close();
                    
                    STATE.processed++;
                    updateUI();

                } else if (entry.kind === 'directory' && !CONFIG.ignoreDirs.includes(entry.name)) {
                    const newSub = await outDir.getDirectoryHandle(entry.name, { create: true });
                    await processRecursive(entry, newSub, relPath);
                }
            }
        }

        async function callAI(code, filename, displayPath) {
            const config = PROVIDERS[STATE.provider];
            const prompt = `Task: Add Chinese comments to "${filename}". Explain logic. Output RAW CODE ONLY (No markdown). Code:\n${code}`;

            let url, body, headers = { 'Content-Type': 'application/json' };
            if (config.type === 'gemini') {
                url = `${STATE.baseUrl}/models/${STATE.model}:generateContent?key=${STATE.key}`;
                body = { contents: [{ parts: [{ text: prompt }] }] };
            } else {
                url = `${STATE.baseUrl}/chat/completions`;
                if (STATE.key) headers['Authorization'] = `Bearer ${STATE.key}`;
                body = {
                    model: STATE.model,
                    messages: [{ role: "system", content: "You are a coding expert. Output code only." }, { role: "user", content: prompt }],
                    temperature: 0.1
                };
            }

            let attempt = 0;
            const MAX_RETRIES = 10;
            let waitTime = 10000;

            while (true) {
                try {
                    const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
                    if (res.status === 429 || res.status === 503) throw new Error("RATE_LIMIT_HIT");

                    if (!res.ok) {
                        const txt = await res.text();
                        if (res.status === 402) throw new Error("ä½™é¢ä¸è¶³");
                        throw new Error(`HTTP ${res.status}: ${txt.slice(0, 30)}`);
                    }

                    const data = await res.json();
                    let result = config.type === 'gemini' ? data.candidates?.[0]?.content?.parts?.[0]?.text : data.choices?.[0]?.message?.content;
                    if (!result) throw new Error("Empty response");
                    return result.replace(/^```[a-z]*\n?/i, '').replace(/\n?```$/, '');
                } catch (e) {
                    const isLimit = e.message === "RATE_LIMIT_HIT" || e.message.includes("429");
                    if (attempt >= MAX_RETRIES) throw new Error(`Max retries: ${e.message}`);

                    if (isLimit) {
                        log(`âš ï¸ é™æµ (429) [${displayPath}] - å†·å´ ${waitTime / 1000}s`, 'warn');
                        await countdown(waitTime / 1000);
                        waitTime *= 2;
                        attempt++;
                    } else {
                        if (attempt < 3) {
                            log(`âš ï¸ é”™è¯¯ (${e.message})ï¼Œé‡è¯•...`, 'warn');
                            await new Promise(r => setTimeout(r, 3000));
                            attempt++;
                        } else throw e;
                    }
                }
            }
        }

        async function countdown(seconds) {
            const statusEl = document.getElementById('fileStatus');
            const originalText = statusEl.textContent;
            for (let i = seconds; i > 0; i--) {
                statusEl.textContent = `â˜• å†·å´ä¸­... ${i}s`;
                await new Promise(r => setTimeout(r, 1000));
            }
            statusEl.textContent = originalText;
        }

        function updateUI(p, status) {
            if (p === undefined || p === null) {
                p = STATE.totalFiles > 0 ? Math.round((STATE.processed / STATE.totalFiles) * 100) : 0;
            }
            document.getElementById('progressFill').style.width = `${p}%`;
            document.getElementById('progressText').textContent = `${p}%`;
            
            // å…³é”®ä¿®æ”¹ï¼šæ›´æ–°æ–‡ä»¶è®¡æ•°
            document.getElementById('progressCount').textContent = `(${STATE.processed}/${STATE.totalFiles})`;
            
            if (status) document.getElementById('fileStatus').textContent = status;
        }

        function log(msg, type) {
            const box = document.getElementById('console');
            const d = document.createElement('div');
            d.innerHTML = `<span class="log-time">[${new Date().toLocaleTimeString('zh-CN', { hour12: false })}]</span><span class="log-${type}">${msg}</span>`;
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }

        function saveConfig() {
            localStorage.setItem('aca_provider', STATE.provider);
            localStorage.setItem('aca_key_' + STATE.provider, STATE.key);
            localStorage.setItem('aca_baseurl', STATE.baseUrl);
            
            const pKey = STATE.provider;
            const isCustomManual = (pKey === 'custom' && document.getElementById('customUseManual').checked);
            
            if (pKey === 'doubao' || isCustomManual) {
                const epVal = document.getElementById('manualEndpoint').value.trim();
                if(epVal) localStorage.setItem('aca_manual_ep_' + pKey, epVal);
            }
        }

        function loadConfig() {
            const p = localStorage.getItem('aca_provider');
            if (p && PROVIDERS[p]) {
                document.getElementById('providerSelect').value = p;
                handleProviderChange();
            } else {
                handleProviderChange();
            }

            const u = localStorage.getItem('aca_baseurl');
            if (u) { document.getElementById('baseUrl').value = u; document.getElementById('baseUrlPreview').textContent = u; }
        }

        function resetApp() { localStorage.clear(); location.reload(); }
        function toggleKey() { const el = document.getElementById('apiKey'); el.type = el.type === 'password' ? 'text' : 'password'; }
        function lockStep(n) { document.getElementById(`step${n}`).className = 'card step-locked'; }
        function unlockStep(n) { document.getElementById(`step${n}`).className = 'card step-active'; }
        function checkStep3() { if (STATE.inHandle && STATE.outHandle) unlockStep(3); }

    </script>
</body>

</html>
